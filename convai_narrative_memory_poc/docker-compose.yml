services:
  zookeeper:
    image: bitnami/zookeeper:3.9
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports: ["2181:2181"]
  kafka:
    image: bitnami/kafka:3.7
    depends_on: [zookeeper]
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    ports: ["9092:9092"]

  qdrant:
    image: qdrant/qdrant:v1.10.1
    ports: ["6333:6333"]
    volumes: ["qdrant_storage:/qdrant/storage"]

  indexer:
    build: ./workers/indexer
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=anchors
    depends_on: [kafka, qdrant]

  resonance:
    build: ./workers/resonance
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=anchors
    depends_on: [kafka, qdrant]

  reteller:
    build: ./workers/reteller
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
      - OPENAI_API_KEY
      - OLLAMA_BASE_URL
    depends_on: [kafka]

  tools:
    build: ./tools
    environment:
      - KAFKA_BOOTSTRAP=kafka:9092
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_COLLECTION=anchors
    depends_on: [kafka, qdrant]

volumes:
  qdrant_storage:
